!function(){function a(a,b){for(var c=0,d=a.length;d>c;++c)b(a[c])}function b(a,b){if(!Array.prototype.indexOf){for(var c=a.length;c--;)if(a[c].toUpperCase()===b.toUpperCase())return!0;return!1}var d=a.map(function(a){return a.toLowerCase()});return-1!=d.indexOf(b.toLowerCase())}function c(c,d,e,f,g,h){function i(a){0!=a.toLowerCase().indexOf(k.toLowerCase())||b(j,a)||j.push(a)}h="undefined"==typeof h?"":h;var j=[],k=c.string;if(d){for(var l=d.pop(),m=!1,n=0;n<g.jsontree.length&&($.each(g.jsontree[n],function(a,b){if("catalogue"==a.toLowerCase()){if(l.string==b){if(h){var c=g.jsontree[n].tables.filter(function(a){return 0==a.name.indexOf(h)});j=j.concat(c.map(function(a){return a.name}))}else j=j.concat(g.jsontree[n].tables.map(function(a){return a.name}));return m=!0,!1}}else if("tables"==a.toLowerCase())for(var d=0;d<g.jsontree[n].tables.length;d++)if(l.string==g.jsontree[n].tables[d].name)if(h){var c=g.jsontree[n].tables[d].columns.filter(function(a){return 0==a.indexOf(h)});j=j.concat(c)}else j=j.concat(g.jsontree[n].tables[d].columns)}),!m);n++);return j.sort()}return a(e,i),j.sort()}function d(c,d,e,g,h,i){function j(a){0!=a.toLowerCase().indexOf(l.toLowerCase())||b(k,a)||k.push(a)}i="undefined"==typeof i?"":i;var k=[],l=c.string;if(d){var m=d.pop();return f(m.string,l,k,h,i),k.sort()}return a(e,j),k.sort()}function e(a,c,d,e){if(a.length>0)for(var f=0;f<a.length;f++)for(var g=jQuery.trim(a[f]),h=g.split("."),i=0;i<h.length;i++)0!=h[i].toLowerCase().indexOf(d.toLowerCase())||b(c,h[i])||h[i].toLowerCase()==e.toLowerCase()||c.push(h[i])}function f(a,b,c,d,f){f="undefined"==typeof f?"":f,d.autocompleteInfo&&jQuery("#"+d.autocompleteInfo).html("Loading catalogue metadata keywords for auto-complete"),d.autocompleteLoader&&jQuery("#"+d.autocompleteLoader).show(),jQuery.ajax({type:"POST",async:!1,data:{keyword:a,optional_keyword:f,mode:"tap",resource:d.tapResource},url:d.webServicePath,timeout:1e6,error:function(){d.autocompleteInfo&&jQuery("#"+d.autocompleteInfo).html("CTRL + Space to activate auto-complete"),d.autocompleteLoader&&jQuery("#"+d.autocompleteLoader).hide()},success:function(f){""!=f&&e(f,c,b,a),d.autocompleteInfo&&jQuery("#"+d.autocompleteInfo).html("CTRL + Space to activate auto-complete"),d.autocompleteLoader&&jQuery("#"+d.autocompleteLoader).hide()}})}function g(c,d,e,f){function g(a){0!=a.toLowerCase().indexOf(j.toLowerCase())||b(i,a)||i.push(a)}function h(b){"string"==typeof b?a(editor.availableTags,g):b instanceof Array?a(editor.availableTags,g):b instanceof Function&&a(editor.availableTags,g);for(var c in b)g(c)}var i=[],j=c.string;if(d){var k,l=d.pop();for(0===l.type.indexOf("variable")?(f&&f.additionalContext&&(k=f.additionalContext[l.string]),k=k||window[l.string]):"string"==l.type?k="":"atom"==l.type?k=1:"function"==l.type&&(null==window.jQuery||"$"!=l.string&&"jQuery"!=l.string||"function"!=typeof window.jQuery?null!=window._&&"_"==l.string&&"function"==typeof window._&&(k=window._()):k=window.jQuery());null!=k&&d.length;)k=k[d.pop().string];null!=k&&h(k)}else a(e,g);return i.sort()}function h(a,b,e,f){var h=a.getCursor(),i=e(a,h),j=i,k=null;for(/^[\w$_]*$/.test(i.string)||(i=j={start:h.ch,end:h.ch,string:"",state:i.state,type:"."==i.string?"property":null}),token_start_original=i.start,token_end_original=i.end,line_original=h.line,cur_temp={},cur_temp.line=h.line,cur_temp.ch=i.start,token_temp=e(a,cur_temp),"."==token_temp.string&&(k=i.string,i=j={start:cur_temp.ch,end:cur_temp.ch,string:"",state:token_temp,type:"."==token_temp.string?"property":null});"property"==j.type;){if(j=e(a,{line:h.line,ch:j.start}),"."!=j.string)return;if(j=e(a,{line:h.line,ch:j.start}),")"==j.string){var l=1;do switch(j=e(a,{line:h.line,ch:j.start}),j.string){case")":l++;break;case"(":l--}while(l>0);if(j=e(a,{line:h.line,ch:j.start}),0!==j.type.indexOf("variable"))return;j.type="function"}if(!m)var m=[];m.push(j)}return"tap"!=a.servicemode.toLowerCase()?"jsontree"==a.servicemode.toLowerCase()?{list:c(i,m,b,f,a,k),from:{line:line_original,ch:token_start_original},to:{line:line_original,ch:token_end_original}}:{list:g(i,m,b,f),from:{line:line_original,ch:token_start_original},to:{line:line_original,ch:token_end_original}}:{list:d(i,m,b,f,a,k),from:{line:line_original,ch:token_start_original},to:{line:line_original,ch:token_end_original}}}CodeMirror.tapHint=function(a,b,c){function d(f){function g(b){a.replaceRange(b,k.from,k.to)}function h(){s||(s=!0,m.parentNode.removeChild(m))}function i(){g(l[n.selectedIndex]),h(),setTimeout(function(){a.focus()},50)}if(!a.somethingSelected()){var j=a.getTokenAt(a.getCursor());if(!e.closeOnTokenChange||null==f||j.start==f.start&&j.type==f.type){var k=b(a,c);if(k&&k.list.length){var l=k.list;if(e.completeSingle&&1==l.length)return g(l[0]),!0;var m=document.createElement("div");m.className="CodeMirror-completions";var n=m.appendChild(document.createElement("select"));window.opera||(n.multiple=!0);for(var o=0;o<l.length;++o){var p=n.appendChild(document.createElement("option"));p.appendChild(document.createTextNode(l[o]))}n.firstChild.selected=!0,n.size=Math.min(10,l.length);var q=a.cursorCoords(e.alignWithWord?k.from:null);m.style.left=q.left+"px",m.style.top=q.bottom+"px",document.body.appendChild(m);var r=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);r-q.left<n.clientWidth&&(m.style.left=q.left-n.clientWidth+"px"),l.length<=10&&(m.style.width=n.clientWidth-1+"px");var s=!1;return CodeMirror.on(n,"blur",h),CodeMirror.on(n,"keydown",function(b){var c=b.keyCode;13==c?(CodeMirror.e_stop(b),i()):27==c?(CodeMirror.e_stop(b),h(),a.focus()):38==c||40==c||33==c||34==c||CodeMirror.isModifierKey(b)||(h(),a.focus(),a.triggerOnKeyDown(b),e.closeOnBackspace&&8==c||setTimeout(function(){d(j)},50))}),CodeMirror.on(n,"dblclick",i),n.focus(),window.opera&&setTimeout(function(){s||n.focus()},100),!0}}}}var e={},f=CodeMirror.tapHint.defaults;c.tapResource&&(a.tapResource=c.tapResource),c.webServicePath&&(a.webServicePath=c.webServicePath),c.autocompleteLoader&&(a.autocompleteLoader=c.autocompleteLoader),c.autocompleteInfo&&(a.autocompleteInfo=c.autocompleteInfo),c.servicemode&&(a.servicemode=c.servicemode),c.jsontree&&(a.jsontree=c.jsontree),c.availableTags?a.availableTags=c.availableTags:a.availableTags||(a.availableTags=["SELECT","FROM","ORDER BY","WHERE","TOP","IN","AND","OR","WITH","DESC","ASC","JOIN","AS","HAVING","ABS","GROUP","BY","INNER","OUTER","CROSS","LEFT","RIGHT","FULL","ON","USING","MIN","MAX","COUNT","DISTINCT","ALL","LIKE","ACOS","ASIN","ATAN","ATAN2","COS","SIN","TAN","COT","IS","NOT","NULL","NATURAL","EXISTS","BETWEEN","AREA","BOX","CENTROID","CIRCLE","CONTAINS","COORD1","COORD2","COORDSYS","DISTANCE","INTERSECTS","POINT","POLYGON","REGION"]);for(var g in f)f.hasOwnProperty(g)&&(e[g]=(c&&c.hasOwnProperty(g)?c:f)[g]);return d()},CodeMirror.tapHint.defaults={closeOnBackspace:!0,closeOnTokenChange:!1,completeSingle:!0,alignWithWord:!0},CodeMirror.adqlHint=function(a,b){return h(a,a.availableTags,function(a,b){return a.getTokenAt(b)},b)}}();