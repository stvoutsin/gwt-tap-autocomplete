var TapAutocomplete=function(a){this.istap=!1,this.servicemode="TAP",a.textfieldid&&(this.textfieldid=a.textfieldid),a.web_service_path&&(this.web_service_path=a.web_service_path),a.html_resource&&(this.html_resource=a.html_resource),a.tap_resource&&(this.tap_resource=a.tap_resource),a.autocomplete_info_id&&(this.autocomplete_info=a.autocomplete_info_id),a.autocomplete_loader_id&&(this.autocomplete_loader=a.autocomplete_loader_id),a.servicemode&&(this.servicemode=a.servicemode),a.initial_catalogues?this.initial_catalogues=a.initial_catalogues:this.initial_catalogues=[],a.jsontree&&(this.jsontree=a.jsontree),"tap"==this.servicemode.toLowerCase()&&(this.istap=!0),null==this.editor&&!jQuery(".CodeMirror").length>0&&(CodeMirror.commands.autocomplete=function(b){CodeMirror.tapHint(b,CodeMirror.adqlHint,{webServicePath:a.web_service_path,tapResource:a.tap_resource,servicemode:a.servicemode.toLowerCase(),autocompleteLoader:a.autocomplete_loader_id,autocompleteInfo:a.autocomplete_info_id,jsontree:a.jsontree})},this.editor=CodeMirror.fromTextArea(document.getElementById(a.textfieldid),{mode:"text/x-adql",tabMode:"indent",lineNumbers:!0,matchBrackets:!0,lineWrapping:!0,textWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"}})),"undefined"==typeof this.editor.availableTags&&(this.editor.availableTags=["SELECT","FROM","ORDER BY","WHERE","TOP","IN","AND","OR","WITH","DESC","ASC","JOIN","AS","HAVING","ABS","GROUP","BY","INNER","OUTER","CROSS","LEFT","RIGHT","FULL","ON","USING","MIN","MAX","COUNT","DISTINCT","ALL","LIKE","ACOS","ASIN","ATAN","ATAN2","COS","SIN","TAN","COT","IS","NOT","NULL","NATURAL","EXISTS","BETWEEN","AREA","BOX","CENTROID","CIRCLE","CONTAINS","COORD1","COORD2","COORDSYS","DISTANCE","INTERSECTS","POINT","POLYGON","REGION"]),"tap"==a.servicemode.toLowerCase()?this.load_metadata_for_autocomplete(this.initial_catalogues):"vosi"==a.servicemode.toLowerCase()?this.load_metadata_from_html():"jsontree"==a.servicemode.toLowerCase()&&this.load_metadata_from_jsontree(this.initial_catalogues)};TapAutocomplete.prototype.push_metadata_content_html=function(a){var b=document.createElement("div");b.innerHTML=a;for(var c=b.getElementsByClassName("heading"),d=b.getElementsByClassName("expand"),e=0;e<c.length;e++)for(var f=jQuery.trim(jQuery(c[e]).justtext()),g=f.split("."),h=0;h<g.length;h++)this.editor.availableTags.push(g[h]);for(var e=0;e<d.length;e++)contains(this.editor.availableTags,d[e].innerHTML)||this.editor.availableTags.push(d[e].innerHTML)},TapAutocomplete.prototype.push_metadata_json=function(a){if(a.length>0)for(var b=0;b<a.length;b++)for(var c=jQuery.trim(a[b]),d=c.split("."),e=0;e<d.length;e++)this.editor.availableTags.push(d[e])},TapAutocomplete.prototype.run=function(){"tap"==this.servicemode.toLowerCase()?this.load_metadata_for_autocomplete():"vosi"==this.servicemode.toLowerCase()?this.load_metadata_from_html():"jsontree"==this.servicemode.toLowerCase()&&this.load_metadata_from_jsontree()},TapAutocomplete.prototype.refresh=function(){CodeMirror.commands.autocomplete=function(a){CodeMirror.tapHint(a,CodeMirror.adqlHint,{webServicePath:this.web_service_path,tapResource:this.tap_resource,servicemode:this.servicemode.toLowerCase(),jsontree:this.jsontree,autocompleteInfo:this.autocomplete_info,autocompleteLoader:this.autocomplete_loader})},"tap"==params.servicemode.toLowerCase()?this.load_metadata_for_autocomplete(this.initial_catalogues):"vosi"==params.servicemode.toLowerCase()?this.load_metadata_from_html():"jsontree"==params.servicemode.toLowerCase()&&this.load_metadata_from_jsontree(this.initial_catalogues)},TapAutocomplete.prototype.load_catalogue_tables=function(a){"tap"==this.servicemode.toLowerCase()?this.load_metadata_for_autocomplete(a):"vosi"==this.servicemode.toLowerCase()?this.load_metadata_from_html():"jsontree"==params.servicemode.toLowerCase()&&this.load_metadata_from_jsontree()},TapAutocomplete.prototype.load_metadata_from_html=function(){function a(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1}function b(b){_this.editor.availableTags||(_this.editor.availableTags=[]);var c=document.createElement("div");c.innerHTML=b;for(var d=c.getElementsByClassName("heading"),e=c.getElementsByClassName("expand"),f=0;f<d.length;f++)for(var g=jQuery.trim(jQuery(d[f]).text()),h=g.split("."),i=0;i<h.length;i++)_this.editor.availableTags.push(h[i]);for(var f=0;f<e.length;f++)a(_this.editor.availableTags,e[f].innerHTML)||_this.editor.availableTags.push(e[f].innerHTML)}_this=this,_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("Loading catalogue metadata keywords for auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).show(),jQuery.ajax({type:"POST",async:!1,data:{resource:_this.html_resource,mode:"vosi"},url:_this.web_service_path,timeout:1e6,error:function(){_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("CTRL + Space to activate auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).hide()},success:function(a){""!=a&&b(a),_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("CTRL + Space to activate auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).hide()}})},TapAutocomplete.prototype.load_metadata_from_jsontree=function(a){function b(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1}function c(c){if(c.length>0)for(var d=0;d<c.length;d++){if(a&&b(a,c[d].catalogue)){var e=c[d].tables.map(function(a){return a.name});_this.editor.availableTags=_this.editor.availableTags.concat(e)}_this.editor.availableTags.push(c[d].catalogue)}}_this=this,_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("Loading catalogue metadata keywords for auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).show(),c(_this.jsontree)},TapAutocomplete.prototype.load_metadata_for_autocomplete=function(a){function b(a){if(a.length>0)for(var b=0;b<a.length;b++)for(var c=jQuery.trim(a[b]),d=c.split("."),e=0;e<d.length;e++)_this.editor.availableTags.push(d[e])}_this=this,a="undefined"==typeof a?[]:a,_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("Loading catalogue metadata keywords for auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).show(),a=JSON.stringify(a),jQuery.ajax({type:"POST",async:!1,data:{resource:_this.tap_resource,optional_catalogues:a,mode:"tap"},url:_this.web_service_path,timeout:1e6,error:function(a){_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("CTRL + Space to activate auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).hide()},success:function(a){""!=a&&b(a),_this.autocomplete_info&&jQuery("#"+_this.autocomplete_info).html("CTRL + Space to activate auto-complete"),_this.autocomplete_loader&&jQuery("#"+_this.autocomplete_loader).hide()}})};